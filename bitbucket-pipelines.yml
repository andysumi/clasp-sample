image: node:9.11.1

pipelines:
  tags:
    '*':
      - step:
          name: echo Environment variables
          deployment: test
          script:
            - echo $CI
            - echo $BITBUCKET_BUILD_NUMBER
            - echo $BITBUCKET_CLONE_DIR
            - echo $BITBUCKET_COMMIT
            - echo $BITBUCKET_REPO_OWNER
            - echo $BITBUCKET_REPO_OWNER_UUID
            - echo $BITBUCKET_REPO_SLUG
            - echo $BITBUCKET_REPO_UUID
            - echo $BITBUCKET_BRANCH
            - echo $BITBUCKET_TAG
            - echo $BITBUCKET_BOOKMARK
            - echo $BITBUCKET_PARALLEL_STEP
            - echo $BITBUCKET_PARALLEL_STEP_COUNT
      - step:
          name: deploy to GAS project
          caches:
            - node
          deployment: production
          script:
            - npm install
            - echo $CRASP_AUTH > ~/.clasprc.json
            - echo $CRASP_CONFIG > .clasp.json
            - npx clasp push
            - npx clasp version $BITBUCKET_TAG
            - version=$(npx clasp versions | tail -1  | sed -e "s/^\([0-9]*\).*$/\1/g")
            - npx clasp redeploy $DEPLOYMENT_ID $version "deploy from gitlab-ci by clasp"
